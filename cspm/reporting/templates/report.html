<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Local CSPM Lite Report</title>
  <style>
    /* basic layout and typography */
    body { font-family: Arial, sans-serif; margin: 24px; }
    .muted { color: #666; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eee; font-size: 12px; }

    /* table layout */
    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #f7f7f7; text-align: left; }

    /* utility classes */
    .right { text-align: right; }
    .mono { font-family: Consolas, monospace; font-size: 12px; }
    .section { margin-top: 24px; }
  </style>
</head>
<body>

  <!-- Page header + generation timestamp -->
  <h1>Local CSPM Lite</h1>
  <p class="muted">Generated: <span class="mono">{{ generated_at }}</span></p>

  <div class="section">
    <h2>Scan Metadata</h2>
    <ul>
      <li>Provider: <span class="pill">{{ snapshot.metadata.provider }}</span></li>
      <li>AWS Account: <span class="mono">{{ snapshot.metadata.account_id }}</span></li>
      <li>Regions: <span class="mono">{{ snapshot.metadata.regions | join(", ") }}</span></li>
      <li>Collected (UTC): <span class="mono">{{ snapshot.metadata.collected_at_utc }}</span></li>
    </ul>
  </div>

  <!-- collected inventory overview -->
  <div class="section">
    <h2>Collected Inventory</h2>

    <!-- security groups per region -->
    <h3>Security Groups (by region)</h3>
    <table>
      <thead>
        <tr>
          <th>Region</th>
          <th class="right">Security Groups</th>
          <th>Collector Notes</th>
        </tr>
      </thead>
      <tbody>
        {# Loop over regions collected under snapshot.aws.regions #}
        {% for region, data in snapshot.aws.regions.items() %}
          <tr>
            <td class="mono">{{ region }}</td>
            <td class="right">
              <!-- If there is a security_groups list, show its length; otherwise 0 -->
              <strong>{{ (data.security_groups | length) if data.security_groups else 0 }}</strong>
            </td>
            <td class="mono">
              {# Show collector error details when present; otherwise a simple OK #}
              {% if data.error %}
                ERROR: {{ data.error.type }} - {{ data.error.message }}
              {% else %}
                OK
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- s3 buckets summary -->
    <h3>S3 Buckets</h3>
    {# Safely resolve buckets; keep behavior identical to previous logic #}
    {% set buckets = snapshot.aws.s3.buckets if snapshot.aws.s3 and snapshot.aws.s3.buckets else [] %}
    <p>Total buckets collected: <strong>{{ buckets | length }}</strong></p>

    {% if buckets | length > 0 %}
      <table>
        <thead>
          <tr>
            <th>Bucket</th>
            <th>Region</th>
            <th>Public Access Block</th>
            <th>Policy Status</th>
          </tr>
        </thead>
        <tbody>
          {# Limit shown rows to first 25 for brevity #}
          {% for b in buckets[:25] %}
            <tr>
              <td class="mono">{{ b.name }}</td>
              <td class="mono">{{ b.region if b.region else "unknown" }}</td>
              <td class="mono">
                {# public_access_block truthiness indicates presence #}
                {% if b.public_access_block %}
                  present
                {% else %}
                  missing/unknown
                {% endif %}
              </td>
              <td class="mono">
                {# policy_status may be nested; print IsPublic when available #}
                {% if b.policy_status and b.policy_status.PolicyStatus %}
                  IsPublic={{ b.policy_status.PolicyStatus.IsPublic }}
                {% else %}
                  none/unknown
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      {% if buckets | length > 25 %}
        <p class="muted">Showing first 25 buckets.</p>
      {% endif %}
    {% endif %}
  </div>

  <!-- Findings list -->
  <div class="section">
    <h2>Findings ({{ findings | length }})</h2>

    {% if findings | length == 0 %}
      <p>No misconfigurations found.</p>
    {% else %}
      <table>
        <thead>
          <tr>
            <th class="right">Risk</th>
            <th>Rule</th>
            <th>Resource</th>
            <th>Region</th>
            <th>Evidence</th>
          </tr>
        </thead>
        <tbody>
          {# One row per finding; fields expected on each `f` object #}
          {% for f in findings %}
            <tr>
              <td class="right"><strong>{{ f.risk_score }}</strong></td>
              <td class="mono">{{ f.rule_id }}</td>
              <td class="mono">{{ f.resource_id }}</td>
              <td class="mono">{{ f.region }}</td>
              <td class="mono">{{ f.evidence }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>

  <!-- drift section -->
  <div class="section">
    <h2>Drift (vs previous scan)</h2>

    {% if drift and drift.available %}
      <p class="muted">
        Previous snapshot: <span class="mono">{{ drift.previous_snapshot_path }}</span><br />
        Latest snapshot: <span class="mono">{{ drift.latest_snapshot_path }}</span>
      </p>

      <ul>
        <li>New findings: <strong>{{ drift.diff.new | length }}</strong></li>
        <li>Resolved findings: <strong>{{ drift.diff.resolved | length }}</strong></li>
        <li>Persisting findings: <strong>{{ drift.diff.persisting | length }}</strong></li>
        <li>Risk increased: <strong>{{ drift.diff.increased_risk | length }}</strong></li>
        <li>Risk decreased: <strong>{{ drift.diff.decreased_risk | length }}</strong></li>
      </ul>

      <h3>New Findings</h3>
      {% if drift.diff.new | length == 0 %}
        <p>No new findings.</p>
      {% else %}
        <table>
          <thead>
            <tr>
              <th class="right">Risk</th>
              <th>Rule</th>
              <th>Resource</th>
              <th>Region</th>
              <th>Evidence</th>
            </tr>
          </thead>
          <tbody>
            {% for f in drift.diff.new[:15] %}
              <tr>
                <td class="right"><strong>{{ f.risk_score }}</strong></td>
                <td class="mono">{{ f.rule_id }}</td>
                <td class="mono">{{ f.resource_id }}</td>
                <td class="mono">{{ f.region }}</td>
                <td class="mono">{{ f.evidence }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if drift.diff.new | length > 15 %}
          <p class="muted">Showing first 15 new findings.</p>
        {% endif %}
      {% endif %}

      <h3>Resolved Findings</h3>
      {% if drift.diff.resolved | length == 0 %}
        <p>No resolved findings.</p>
      {% else %}
        <table>
          <thead>
            <tr>
              <th class="right">Prev Risk</th>
              <th>Rule</th>
              <th>Resource</th>
              <th>Region</th>
            </tr>
          </thead>
          <tbody>
            {% for f in drift.diff.resolved[:15] %}
              <tr>
                <td class="right"><strong>{{ f.risk_score }}</strong></td>
                <td class="mono">{{ f.rule_id }}</td>
                <td class="mono">{{ f.resource_id }}</td>
                <td class="mono">{{ f.region }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if drift.diff.resolved | length > 15 %}
          <p class="muted">Showing first 15 resolved findings.</p>
        {% endif %}
      {% endif %}

      <h3>Risk Increased</h3>
      {% if drift.diff.increased_risk | length == 0 %}
        <p>No increased-risk findings.</p>
      {% else %}
        <table>
          <thead>
            <tr>
              <th class="right">Before</th>
              <th class="right">After</th>
              <th>Rule</th>
              <th>Resource</th>
              <th>Region</th>
            </tr>
          </thead>
          <tbody>
            {% for x in drift.diff.increased_risk[:15] %}
              <tr>
                <td class="right">{{ x.before_risk }}</td>
                <td class="right"><strong>{{ x.after_risk }}</strong></td>
                <td class="mono">{{ x.after.rule_id }}</td>
                <td class="mono">{{ x.after.resource_id }}</td>
                <td class="mono">{{ x.after.region }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if drift.diff.increased_risk | length > 15 %}
          <p class="muted">Showing first 15 increased-risk items.</p>
        {% endif %}
      {% endif %}

      <h3>Risk Decreased</h3>
      {% if drift.diff.decreased_risk | length == 0 %}
        <p>No decreased-risk findings.</p>
      {% else %}
        <table>
          <thead>
            <tr>
              <th class="right">Before</th>
              <th class="right">After</th>
              <th>Rule</th>
              <th>Resource</th>
              <th>Region</th>
            </tr>
          </thead>
          <tbody>
            {% for x in drift.diff.decreased_risk[:15] %}
              <tr>
                <td class="right">{{ x.before_risk }}</td>
                <td class="right"><strong>{{ x.after_risk }}</strong></td>
                <td class="mono">{{ x.after.rule_id }}</td>
                <td class="mono">{{ x.after.resource_id }}</td>
                <td class="mono">{{ x.after.region }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if drift.diff.decreased_risk | length > 15 %}
          <p class="muted">Showing first 15 decreased-risk items.</p>
        {% endif %}
      {% endif %}

    {% else %}
      <p class="muted">
        Drift is not available yet. Run at least <strong>two scans</strong> to compare changes.
      </p>
    {% endif %}
  </div>

</body>
</html>
