<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Local CSPM Lite Report</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 24px; }
    .muted { color: #666; }
    .pill { display: inline-block; padding: 2px 8px; border-radius: 999px; background: #eee; font-size: 12px; }

    table { width: 100%; border-collapse: collapse; margin-top: 16px; }
    th, td { border: 1px solid #ddd; padding: 8px; vertical-align: top; }
    th { background: #f7f7f7; text-align: left; }

    .right { text-align: right; }
    .mono { font-family: Consolas, monospace; font-size: 12px; }
    .section { margin-top: 24px; }

    /* drift highlighting */
    .row-new { background: #ffe8e8; }
    .row-resolved { background: #e8ffea; }
    .row-increased { background: #fff2e0; }
    .row-decreased { background: #e8f3ff; }

    /* coverage highlighting */
    .ok { color: #0a7a0a; font-weight: bold; }
    .err { color: #b00020; font-weight: bold; }
    
    /* coverage score colors */
    .coverage-full { background-color: #0a7a0a; color: white; font-weight: bold; }
    .coverage-partial { background-color: #ff9800; color: white; font-weight: bold; }
    .coverage-limited { background-color: #b00020; color: white; font-weight: bold; }

    /* remediation styling */
    .remediation-success { background-color: #e8ffea; }
    .remediation-skipped { background-color: #fff3cd; }
    .remediation-failed { background-color: #ffe8e8; }
    .remediation-dryrun { background-color: #e8f3ff; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
    .badge-success { background-color: #0a7a0a; color: white; }
    .badge-skipped { background-color: #ff9800; color: white; }
    .badge-failed { background-color: #b00020; color: white; }
    .badge-dryrun { background-color: #2196f3; color: white; }
  </style>
</head>
<body>

  <h1>Local CSPM Lite</h1>
  <p class="muted">Generated: <span class="mono">{{ generated_at }}</span></p>

  <div class="section">
    <h2>Scan Metadata</h2>
    <ul>
      <li>Provider: <span class="pill">{{ snapshot.metadata.provider }}</span></li>
      <li>AWS Account: <span class="mono">{{ snapshot.metadata.account_id }}</span></li>
      <li>Regions: <span class="mono">{{ snapshot.metadata.regions | join(", ") }}</span></li>
      <li>Collected (UTC): <span class="mono">{{ snapshot.metadata.collected_at_utc }}</span></li>
      {% if coverage_summary %}
        {% if coverage_summary.score == 'FULL' %}
          {% set coverage_class = 'coverage-full' %}
        {% elif coverage_summary.score == 'PARTIAL' %}
          {% set coverage_class = 'coverage-partial' %}
        {% else %}
          {% set coverage_class = 'coverage-limited' %}
        {% endif %}
        <li>
          Coverage: 
          <span class="pill {{ coverage_class }}">
            {{ coverage_summary.score }}
          </span>
          <span class="muted">
            ({{ coverage_summary.successful_apis }}/{{ coverage_summary.total_apis }} APIs successful)
          </span>
        </li>
      {% endif %}
    </ul>
  </div>

  <!-- (new) permissions & coverage -->
  <div class="section">
    <h2>Permissions & Coverage</h2>

    {% set cov = snapshot.aws.coverage if snapshot.aws and snapshot.aws.coverage else None %}
    {% if not cov %}
      <p class="muted">Coverage data not available (older snapshot format or demo snapshot).</p>
    {% else %}
      <p class="muted">
        This shows which AWS API calls were accessible during the scan. Missing access can reduce scan coverage.
      </p>

      <table>
        <thead>
          <tr>
            <th>Service</th>
            <th>Action</th>
            <th>Status</th>
            <th>Error</th>
          </tr>
        </thead>
        <tbody>
          {% for service, actions in cov.items() %}
            {% for action, info in actions.items() %}
              <tr>
                <td class="mono">{{ service }}</td>
                <td class="mono">{{ action }}</td>
                <td class="mono">
                  {% if info.status == "OK" %}
                    <span class="ok">OK</span>
                  {% else %}
                    <span class="err">ERROR</span>
                  {% endif %}
                </td>
                <td class="mono">
                  {% if info.status != "OK" %}
                    {{ info.error_code }} - {{ info.message }}
                  {% else %}
                    â€”
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          {% endfor %}
        </tbody>
      </table>
    {% endif %}
  </div>

  <div class="section">
    <h2>Collected Inventory</h2>

    <h3>Security Groups (by region)</h3>
    <table>
      <thead>
        <tr>
          <th>Region</th>
          <th class="right">Security Groups</th>
          <th>Collector Notes</th>
        </tr>
      </thead>
      <tbody>
        {% for region, data in snapshot.aws.regions.items() %}
          <tr>
            <td class="mono">{{ region }}</td>
            <td class="right">
              <strong>{{ (data.security_groups | length) if data.security_groups else 0 }}</strong>
            </td>
            <td class="mono">
              {% if data.error %}
                ERROR: {{ data.error.type }} - {{ data.error.message }}
              {% else %}
                OK
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <h3>S3 Buckets</h3>
    {% set buckets = snapshot.aws.s3.buckets if snapshot.aws.s3 and snapshot.aws.s3.buckets else [] %}
    <p>Total buckets collected: <strong>{{ buckets | length }}</strong></p>

    {% if buckets | length > 0 %}
      <table>
        <thead>
          <tr>
            <th>Bucket</th>
            <th>Region</th>
            <th>Public Access Block</th>
            <th>Policy Status</th>
          </tr>
        </thead>
        <tbody>
          {% for b in buckets[:25] %}
            <tr>
              <td class="mono">{{ b.name }}</td>
              <td class="mono">{{ b.region if b.region else "unknown" }}</td>
              <td class="mono">
                {% if b.public_access_block %}
                  present
                {% else %}
                  missing/unknown
                {% endif %}
              </td>
              <td class="mono">
                {% if b.policy_status and b.policy_status.PolicyStatus %}
                  IsPublic={{ b.policy_status.PolicyStatus.IsPublic }}
                {% else %}
                  none/unknown
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
      {% if buckets | length > 25 %}
        <p class="muted">Showing first 25 buckets.</p>
      {% endif %}
    {% endif %}
  </div>

  <div class="section">
    <h2>Findings ({{ findings | length }})</h2>

    {% if findings | length == 0 %}
      <p>No misconfigurations found.</p>
    {% else %}
      {% set evaluated_findings = [] %}
      {% set not_evaluated_findings = [] %}
      {% for f in findings %}
        {% if f.status == "NOT_EVALUATED" %}
          {% set _ = not_evaluated_findings.append(f) %}
        {% else %}
          {% set _ = evaluated_findings.append(f) %}
        {% endif %}
      {% endfor %}
      
      {% if evaluated_findings | length > 0 %}
        <h3>Evaluated Findings ({{ evaluated_findings | length }})</h3>
        <table>
          <thead>
            <tr>
              <th class="right">Risk</th>
              <th>Rule</th>
              <th>Resource</th>
              <th>Region</th>
              <th>Evidence</th>
            </tr>
          </thead>
          <tbody>
            {% for f in evaluated_findings %}
              <tr>
                <td class="right"><strong>{{ f.risk_score }}</strong></td>
                <td class="mono">{{ f.rule_id }}</td>
                <td class="mono">{{ f.resource_id }}</td>
                <td class="mono">{{ f.region }}</td>
                <td class="mono">{{ f.evidence }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}

      {% if not_evaluated_findings | length > 0 %}
        <h3>Not Evaluated ({{ not_evaluated_findings | length }})</h3>
        <p class="muted">
          These rules could not be evaluated due to missing AWS permissions. Grant the required permissions to enable evaluation.
        </p>
        <table>
          <thead>
            <tr>
              <th>Rule</th>
              <th>Resource</th>
              <th>Region</th>
              <th>Reason</th>
            </tr>
          </thead>
          <tbody>
            {% for f in not_evaluated_findings %}
              <tr style="background: #fff3cd;">
                <td class="mono">{{ f.rule_id }}</td>
                <td class="mono">{{ f.resource_id }}</td>
                <td class="mono">{{ f.region }}</td>
                <td class="mono">
                  <span class="err">Missing permission: {{ f.missing_permission }}</span>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    {% endif %}
  </div>

  <!-- Remediation Summary Section -->
  <div class="section">
    <h2>Remediation Summary</h2>

    {% if remediation %}
      <p class="muted">
        Mode: 
        {% if remediation.dry_run %}
          <span class="badge badge-dryrun">DRY-RUN</span> (no changes made)
        {% else %}
          <span class="badge badge-success">LIVE</span> (changes applied)
        {% endif %}
      </p>

      <ul>
        <li>Eligible findings: <strong>{{ remediation.eligible_count }}</strong></li>
        <li>Applied: <strong>{{ remediation.applied_count }}</strong></li>
        <li>Skipped: <strong>{{ remediation.skipped_count }}</strong></li>
        <li>Failed: <strong>{{ remediation.failed_count }}</strong></li>
      </ul>

      {% if remediation.applied | length > 0 %}
        <h3>Applied Remediations</h3>
        <table>
          <thead>
            <tr>
              <th>Status</th>
              <th>Rule</th>
              <th>Resource</th>
              <th>Action</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            {% for r in remediation.applied %}
              <tr class="{% if remediation.dry_run %}remediation-dryrun{% else %}remediation-success{% endif %}">
                <td>
                  {% if remediation.dry_run %}
                    <span class="badge badge-dryrun">DRY-RUN</span>
                  {% else %}
                    <span class="badge badge-success">SUCCESS</span>
                  {% endif %}
                </td>
                <td class="mono">{{ r.rule_id }}</td>
                <td class="mono">{{ r.resource_id }}</td>
                <td class="mono">{{ r.action }}</td>
                <td class="mono">{{ r.reason }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}

      {% if remediation.skipped | length > 0 %}
        <h3>Skipped Remediations</h3>
        <table>
          <thead>
            <tr>
              <th>Status</th>
              <th>Rule</th>
              <th>Resource</th>
              <th>Reason</th>
            </tr>
          </thead>
          <tbody>
            {% for r in remediation.skipped[:20] %}
              <tr class="remediation-skipped">
                <td><span class="badge badge-skipped">SKIPPED</span></td>
                <td class="mono">{{ r.rule_id }}</td>
                <td class="mono">{{ r.resource_id }}</td>
                <td class="mono">{{ r.reason }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
        {% if remediation.skipped | length > 20 %}
          <p class="muted">Showing first 20 of {{ remediation.skipped | length }} skipped remediations.</p>
        {% endif %}
      {% endif %}

      {% if remediation.failed | length > 0 %}
        <h3>Failed Remediations</h3>
        <table>
          <thead>
            <tr>
              <th>Status</th>
              <th>Rule</th>
              <th>Resource</th>
              <th>Reason</th>
            </tr>
          </thead>
          <tbody>
            {% for r in remediation.failed %}
              <tr class="remediation-failed">
                <td><span class="badge badge-failed">FAILED</span></td>
                <td class="mono">{{ r.rule_id }}</td>
                <td class="mono">{{ r.resource_id }}</td>
                <td class="mono">{{ r.reason }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}

    {% else %}
      <p class="muted">
        Remediation was not requested for this scan. Use <code>--remediate</code> flag to enable auto remediation.
      </p>
    {% endif %}
  </div>

  <div class="section">
    <h2>Drift (vs previous scan)</h2>

    {% if drift and drift.available %}
      <p class="muted">
        Previous snapshot: <span class="mono">{{ drift.previous_snapshot_path }}</span><br />
        Latest snapshot: <span class="mono">{{ drift.latest_snapshot_path }}</span>
      </p>

      <ul>
        <li>New findings: <strong>{{ drift.diff.new | length }}</strong></li>
        <li>Resolved findings: <strong>{{ drift.diff.resolved | length }}</strong></li>
        <li>Persisting findings: <strong>{{ drift.diff.persisting | length }}</strong></li>
        <li>Risk increased: <strong>{{ drift.diff.increased_risk | length }}</strong></li>
        <li>Risk decreased: <strong>{{ drift.diff.decreased_risk | length }}</strong></li>
      </ul>

      <h3>New Findings</h3>
      {% if drift.diff.new | length == 0 %}
        <p>No new findings.</p>
      {% else %}
        <table>
          <thead>
            <tr>
              <th class="right">Risk</th>
              <th>Rule</th>
              <th>Resource</th>
              <th>Region</th>
              <th>Evidence</th>
            </tr>
          </thead>
          <tbody>
            {% for f in drift.diff.new[:15] %}
              <tr class="row-new">
                <td class="right"><strong>{{ f.risk_score }}</strong></td>
                <td class="mono">{{ f.rule_id }}</td>
                <td class="mono">{{ f.resource_id }}</td>
                <td class="mono">{{ f.region }}</td>
                <td class="mono">{{ f.evidence }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}

      <h3>Resolved Findings</h3>
      {% if drift.diff.resolved | length == 0 %}
        <p>No resolved findings.</p>
      {% else %}
        <table>
          <thead>
            <tr>
              <th class="right">Prev Risk</th>
              <th>Rule</th>
              <th>Resource</th>
              <th>Region</th>
            </tr>
          </thead>
          <tbody>
            {% for f in drift.diff.resolved[:15] %}
              <tr class="row-resolved">
                <td class="right"><strong>{{ f.risk_score }}</strong></td>
                <td class="mono">{{ f.rule_id }}</td>
                <td class="mono">{{ f.resource_id }}</td>
                <td class="mono">{{ f.region }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}

      <h3>Risk Increased</h3>
      {% if drift.diff.increased_risk | length == 0 %}
        <p>No increased-risk findings.</p>
      {% else %}
        <table>
          <thead>
            <tr>
              <th class="right">Before</th>
              <th class="right">After</th>
              <th>Rule</th>
              <th>Resource</th>
              <th>Region</th>
            </tr>
          </thead>
          <tbody>
            {% for x in drift.diff.increased_risk[:15] %}
              <tr class="row-increased">
                <td class="right">{{ x.before_risk }}</td>
                <td class="right"><strong>{{ x.after_risk }}</strong></td>
                <td class="mono">{{ x.after.rule_id }}</td>
                <td class="mono">{{ x.after.resource_id }}</td>
                <td class="mono">{{ x.after.region }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}

      <h3>Risk Decreased</h3>
      {% if drift.diff.decreased_risk | length == 0 %}
        <p>No decreased-risk findings.</p>
      {% else %}
        <table>
          <thead>
            <tr>
              <th class="right">Before</th>
              <th class="right">After</th>
              <th>Rule</th>
              <th>Resource</th>
              <th>Region</th>
            </tr>
          </thead>
          <tbody>
            {% for x in drift.diff.decreased_risk[:15] %}
              <tr class="row-decreased">
                <td class="right">{{ x.before_risk }}</td>
                <td class="right"><strong>{{ x.after_risk }}</strong></td>
                <td class="mono">{{ x.after.rule_id }}</td>
                <td class="mono">{{ x.after.resource_id }}</td>
                <td class="mono">{{ x.after.region }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endif %}
    {% else %}
      <p class="muted">
        Drift is not available yet. Run at least <strong>two scans</strong> to compare changes.
      </p>
    {% endif %}
  </div>

</body>
</html>
